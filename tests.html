<!DOCTYPE html>
<html>
	<head>
		<title>Multisort UX tests</title>
		<meta charset="utf8" />
		<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.20.0.css">
		<link rel="stylesheet" media="all" type="text/css" href="css/multisort-ux.css" />
		<script src="http://code.jquery.com/qunit/qunit-1.20.0.js"></script>
		<script src="js/multisort-ux.js" type="text/javascript"></script>
		<script src="js/array-unique.js" type="text/javascript"></script>
		<script type="text/javascript">
		
		function getMatrix(r, c) {	
			var i = 0, l, b, m = [], p, w = 0, log = 0;
			
			b = Array.apply(null, Array(c)).map(Number.prototype.valueOf,0);
			l = r;
			p = Math.round(l / c);
				
			if (log) console.log('data matrics for (', b.length, ') column table');
			
			for (; i < l; i += 1) {
				if (i % p) {
					w +=1;
					if (w === b.length) {
						w = 0;
					}
					b[w] -= 1;
				} else {
					b[w] += 1;
				}
				b[w] = Math.abs(b[w]);
				if (log) console.log(b);
				m.push(b.slice(0));
			}
			
			return m;
		}
		
		function formatData(d) {
			var data = [],
			a = getLetters(), 
			c,
			i = 0, 
			l = d.length, 
			o,
			r,
			t;
			
			for (; i < l; i += 1) {
				o = {};
				o.id = i + 1;
				r = d[i]; 
				if (!c) c = r.length;
				for(t = 0; t < c; t += 1) {
					o[a[t]] = r[t];
				}
				data.push(o);
			}
			return data;
		}
		
		function FindAllLetterCasePermutations(s) {
			var sp = s.split(""), buffer = [];
			for (var i = 0, l = 1 << s.length; i < l; i++) {
				for (var j = i, k = 0; j; j >>= 1, k++) {
					sp[k] = (j & 1) ? sp[k].toUpperCase() : sp[k].toLowerCase();
				}
				buffer.push(sp.join(""));
			}
			return buffer;
		}
		
		function FindAllPermutations(str, index, buffer) {
			if (typeof str == "string")
				str = str.split("");
			if (typeof index == "undefined")
				index = 0;
			if (typeof buffer == "undefined")
				buffer = [];
			if (index >= str.length)
				return buffer;
			for (var i = index; i < str.length; i++)
				buffer.push(ToggleLetters(str, index, i));
			return FindAllPermutations(str, index + 1, buffer);
		}

		function ToggleLetters(str, index1, index2) {
			if (index1 != index2) {
				var temp = str[index1];
				str[index1] = str[index2];
				str[index2] = temp;
			}
			return str.join("");
		}
		
		function getPattern(l) {
			var c, buffer = [], pattern = {};
			c = FindAllPermutations(getLetters().splice(0, l).join(''));
			for (var i = 0, l = c.length; i < l; i += 1) {
				buffer = buffer.concat(FindAllLetterCasePermutations(c[i]));
			}
			buffer = buffer.getUnique();
			
			(function (print) {
				if (print) {
					for (var i = 0, l = buffer.length; i < l; i += 1) {
						console.log('test case:', buffer[i]);
					}
				}
			})(0);
			
			buffer.map(function (s) {
				var r = s.split('');
				pattern[s] = [];
				for (var i = 0, l = r.length; i < l; i += 1) {
					pattern[s].push([r[i].toLowerCase(), r[i] === r[i].toLowerCase() ? '<' : '>']);
				}
			});
			pattern.expected = buffer.length;
			return pattern;
		}

		QUnit.test('reindexing array shifting index 3 to index 2', function(assert) {
			var testArray = [], a, b, p, x;
			
			assert.notOk(testArray.length, 'empty array');
			for (var i = 0; i < 10; i += 1) {
				testArray[i] = [i.toString(10)];
			}
			assert.equal(testArray.length, 10, 'array length is correct');
			assert.notOk(testArray[testArray.length], 'index out of reach');
			assert.equal(testArray[testArray.length - 1], testArray[9], 'elements are indexed correct');
			
			a = testArray[3];
			b = testArray[2];
			p = 3;
			
			assert.equal(testArray[3], a, 'arrays in arrays are stored by referrence');
			
			// shifting down
			x = testArray[p - 1];
			testArray[p - 1] = testArray[p];
			testArray[p] = x;
			
			assert.equal(testArray.length, 10, 'length of the array is unchanged');
			assert.equal(testArray[2], a, 'referenced array ( a ) can be found on lower index');
			assert.equal(testArray[3], b, 'referenced array ( b ) can be found on higher index');
		});
		
		QUnit.test('reindexing array pushing index 3 to index 4', function(assert) {
			var testArray = [], a, b, p, x;
			for (var i = 0; i < 10; i += 1) {
				testArray[i] = [i.toString(10), '+'];
			}
			
			a = testArray[3];
			b = testArray[4];
			p = 3;
			
			x = testArray[p];
			testArray[p] = testArray[p + 1];
			testArray[p + 1] = x;
			
			assert.equal(testArray.length, 10, 'length of the array is unchanged');
			assert.equal(testArray[3], b, 'referenced array ( b ) can be found on lower index');
			assert.equal(testArray[4], a, 'referenced array ( a ) can be found on higher index');
		});
		
		function compareResults(assert, expected, testResults) {
			var last = '', cnt = 0;
			for (var r in testResults.individualResults) {
				(function (current) {
					if (!last)  {
						last = current;
					} else {
						if (testResults.individualResults[last].join('') == testResults.individualResults[current].join('')) {
							console.log(last, testResults.individualResults[last].join(''));
							console.log(current, testResults.individualResults[current].join(''));
							last = '';
						}
					}
				})(r);
				cnt++;
			}
			
			assert.ok(last, 'no duplicate results found in individual testResults');
			
			var unique = testResults.totalResults.map(function (i) {
				return i.join('');
			});
			
			assert.equal(unique.length, expected, 'all testResults passed');
			assert.equal(unique.getUnique().length, expected, 'result length unchanged after filtering duplicates');
		}
		
		function runNTest(numColumns, assert, callback) {
		
			var pattern = getPattern(numColumns), data = formatData(getMatrix(pattern.expected, numColumns)), testResults = {};
			testResults.individualResults = {};
			testResults.totalResults = [];
			
			function storeResults(test, result) {
				testResults.individualResults[test] = result.map(function (o) {
					return o.id;
				});
				testResults.totalResults.push(testResults.individualResults[test]);
			};
			
			for (var test in pattern) {
				if (test === "expected") continue;
				storeResults(test, data.slice(0).sort(sortByMultiple.apply(null, pattern[test])));
			}
			
			if (typeof callback === 'function') {
				callback(data, testResults);
			} else {
				compareResults(assert, pattern.expected, testResults);
			}
		}
		
		QUnit.test('multi sorting: running tests on two column table', function (assert) {
			runNTest(2, assert);
		});
		
		QUnit.test('multi sorting: running tests on three column table', function (assert) {
			runNTest(3, assert);
		});
		
		QUnit.test('multi sorting: running tests on four column table', function (assert) {
			runNTest(4, assert)
		});
		
		QUnit.test('multi sorting: running tests on five column table', function (assert) {
			runNTest(5, assert);
		});
		
		QUnit.test('attempt to facade events in internet explorer', function (assert) {
			expect(1);
			var done = assert.async(1);
			var t = document.querySelector('#my-table');
			t.addEventListener('hack', function (e) {
				assert.ok(e.detail, 'I hacked it!');
				done();
			});
			var e = getEvent('hack', {detail : 1});
			t.dispatchEvent(e);
		});
		
		QUnit.test('testing buttons and event handlers', function (assert) {
			
			runNTest(2, assert, function (data, testResults) {
								
				var done = assert.async(2), btn2Clicked = false;
				
				document.querySelector('#my-table').addEventListener('selection', (function (results) {
					return function (e) {
						if (btn2Clicked) {
							assert.equal(results.ab.join(''), e.detail.selected.join(''), 'both buttons clicked: sort case ab');
						} else {
							assert.ok(e.detail, 'CustomEvent supported');
						}
						done();
					};
				})(testResults.individualResults));
				
				renderTable({
					'data' : data
				});
				
				var onbtns = document.querySelectorAll('.on b');
				assert.equal(onbtns.length, 2, 'table is rendered and we have buttons');
				onbtns[0].dispatchEvent(getEvent('click'));
				setTimeout(function () {
					btn2Clicked = true;
					onbtns[1].dispatchEvent(getEvent('click'));
				}, 10);
			});
			
			var ctrlcells = document.querySelectorAll('#my-table thead tr.c td:not(:first-child)');
			assert.equal(ctrlcells.length, 2, 'controll cells rendered for each column');
			
			var children = ctrlcells[0].childNodes;
			assert.equal(children.length, 4, '.on .off .inc .dec controls');
			for (var i = children.length - 1, classNames = 'dec on off inc'.split(' '); i > -1; --i) {
				assert.ok(children[i].classList.contains(classNames[i]), ['controll (', classNames[i], ') in right position'].join(''));
			}
		});
		
		QUnit.test('select all checkbox ans select range tests', function (assert) {
			var data = formatData(getMatrix(8, 2));
			
			renderTable({
				'data' : data
			});
			
			
			var all = document.querySelectorAll('#my-table thead input[type="checkbox"]');
			assert.ok(all.length === 1, 'only one checkbox is in table header');
			assert.ok(all[0].checked, 'by default it is checked');
			
			
			
		});
		
		</script>
	</head>
	<body>
		
		<div id="qunit"></div>

		<div id="qunit-fixture">
			<table id="my-table" class="basic">
				<caption>
					<textarea>
						<tr>
							<td><input type="checkbox" {{checked}} value="{{id}}" /></td>
							<td>{{a}}</td>
							<td>{{b}}</td>
						</tr>
					</textarea>
					
					<div class="counters">
						<span class="selected">0</span>/<span class="total">0</span>
					</div>
					
					<div class="select-range-controls">
						<label>Range</label>
						<input value="" size="5" />
						<span class="increment"></span>
						<span class="decrement"></span>
					</div>
					
				</caption>
				<thead>
					<tr>
						<td><input type="checkbox" checked /></td>
						<td data-col="a">A</td>
						<td data-col="b">B</td>
					</tr>
				<thead>
				<tfoot></tfoot>
				<tbody></tbody>
			</table>
		</div>
	</body>
</html>